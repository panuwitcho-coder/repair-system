<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡πà‡∏≤‡∏á | ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Kanit:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--p:#0A2342;--p2:#1B4F8A;--acc:#F4A926;--ok:#27AE60;--err:#E74C3C;--bg:#EEF2F7;--card:#fff;--text:#1A2B3C;--muted:#7A8DA0;--border:#D1DCE8;--sh:0 4px 24px rgba(10,35,66,.10)}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Sarabun',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
header{background:var(--p);color:#fff;padding:0 28px;display:flex;align-items:center;justify-content:space-between;height:64px;box-shadow:0 2px 16px rgba(10,35,66,.18);position:sticky;top:0;z-index:100}
.logo{font-family:'Kanit',sans-serif;font-size:1.25rem;font-weight:700;display:flex;align-items:center;gap:10px}
.logo-icon{width:34px;height:34px;background:var(--acc);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1rem}
.nav a{color:rgba(255,255,255,.75);text-decoration:none;margin-left:20px;font-size:.88rem}
.nav a:hover,.nav a.active{color:var(--acc)}
/* LOGIN SCREEN */
.login-wrap{min-height:calc(100vh - 64px);display:flex;align-items:center;justify-content:center;padding:20px}
.login-card{background:var(--card);border-radius:18px;padding:40px;max-width:400px;width:100%;box-shadow:var(--sh);text-align:center}
.login-icon{font-size:3rem;margin-bottom:12px}
.login-title{font-family:'Kanit',sans-serif;font-size:1.5rem;font-weight:700;color:var(--p);margin-bottom:6px}
.login-sub{color:var(--muted);font-size:.9rem;margin-bottom:24px}
.container{max-width:1000px;margin:0 auto;padding:28px 16px}
.card{background:var(--card);border-radius:16px;box-shadow:var(--sh);padding:24px;margin-bottom:20px}
.card-title{font-family:'Kanit',sans-serif;font-size:1.05rem;font-weight:700;color:var(--p);margin-bottom:16px;display:flex;align-items:center;gap:8px}
.fg{margin-bottom:14px}
label{display:block;font-size:.85rem;font-weight:700;margin-bottom:5px}
input,select,textarea{width:100%;padding:10px 13px;border:1.5px solid var(--border);border-radius:9px;font-family:'Sarabun',sans-serif;font-size:.92rem;color:var(--text);background:#fafbfd;outline:none;transition:border-color .2s}
input:focus,select:focus{border-color:var(--p)}
textarea{resize:vertical;min-height:70px}
.btn{display:inline-flex;align-items:center;gap:6px;padding:10px 20px;border:none;border-radius:9px;font-family:'Sarabun',sans-serif;font-size:.9rem;font-weight:700;cursor:pointer;transition:all .2s;white-space:nowrap}
.btn:hover{opacity:.88}
.btn-primary{background:var(--p);color:#fff;width:100%}
.btn-success{background:var(--ok);color:#fff}
.btn-warning{background:var(--acc);color:var(--p)}
.btn-sm{padding:6px 12px;font-size:.8rem;border-radius:7px}
/* JOB CARDS */
.job-card{border:2px solid var(--border);border-radius:14px;padding:18px;margin-bottom:14px;transition:all .2s}
.job-card:hover{border-color:var(--p)}
.job-card.urgent{border-color:var(--err);background:#FFF8F8}
.job-card.medium{border-color:var(--acc)}
.job-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:10px}
.job-id{font-size:.75rem;color:var(--muted)}
.job-title{font-weight:700;font-size:1rem;margin-bottom:4px}
.job-meta{font-size:.82rem;color:var(--muted);margin-bottom:8px}
.badge{display:inline-block;padding:3px 9px;border-radius:18px;font-size:.72rem;font-weight:700;white-space:nowrap}
.badge-pending{background:#FFF3CD;color:#856404}.badge-assigned{background:#E8D5FF;color:#6B21A8}.badge-inprogress{background:#CCE5FF;color:#0056B3}.badge-done{background:#D4EDDA;color:#155724}
.badge-low{background:#EDFBF4;color:#27AE60}.badge-medium{background:#FFF8EC;color:#D68910}.badge-high{background:#FEECEB;color:#E74C3C}
/* IMG */
.img-upload-zone{border:2px dashed var(--border);border-radius:10px;padding:14px;text-align:center;cursor:pointer;position:relative;transition:all .2s;margin-top:8px}
.img-upload-zone:hover{border-color:var(--p)}
.img-upload-zone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.gallery-grid{display:flex;flex-wrap:wrap;gap:7px;margin-top:8px}
.gallery-grid img{width:70px;height:70px;object-fit:cover;border-radius:7px;border:2px solid var(--border);cursor:pointer}
.img-preview-grid{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.img-thumb{position:relative;width:62px;height:62px;border-radius:7px;overflow:hidden;border:2px solid var(--border)}
.img-thumb img{width:100%;height:100%;object-fit:cover}
.img-thumb .del-img{position:absolute;top:1px;right:1px;background:rgba(0,0,0,.6);color:#fff;border:none;border-radius:50%;width:16px;height:16px;font-size:.65rem;cursor:pointer;display:flex;align-items:center;justify-content:center}
/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;display:flex;align-items:center;justify-content:center;padding:16px;opacity:0;pointer-events:none;transition:opacity .3s}
.modal-overlay.open{opacity:1;pointer-events:all}
.modal{background:#fff;border-radius:16px;padding:26px;max-width:520px;width:100%;max-height:92vh;overflow-y:auto;transform:scale(.93);transition:transform .3s}
.modal-overlay.open .modal{transform:scale(1)}
.modal-close{float:right;border:none;background:var(--bg);border-radius:7px;padding:4px 10px;cursor:pointer;font-size:.9rem;color:var(--muted)}
.det-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:.87rem}
.det-row:last-child{border-bottom:none}.det-lbl{color:var(--muted)}.det-val{font-weight:700;text-align:right}
.timeline{padding:12px;background:var(--bg);border-radius:10px;margin-top:12px}
.t-item{display:flex;gap:9px;margin-bottom:8px;font-size:.8rem}
.t-dot{width:7px;height:7px;background:var(--p);border-radius:50%;margin-top:4px;flex-shrink:0}
/* LIGHTBOX */
#lightbox{position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:500;display:none;align-items:center;justify-content:center}
#lightbox.open{display:flex}
#lightbox img{max-width:92vw;max-height:92vh;border-radius:10px}
#lightbox .lb-close{position:absolute;top:20px;right:24px;color:#fff;font-size:2rem;cursor:pointer;background:none;border:none}
.toast{position:fixed;top:80px;right:18px;padding:13px 20px;border-radius:11px;font-weight:700;transform:translateX(200%);transition:transform .4s cubic-bezier(.34,1.56,.64,1);z-index:999;font-size:.9rem}
.toast.success{background:var(--ok);color:#fff}.toast.error{background:var(--err);color:#fff}
.toast.show{transform:translateX(0)}
footer{background:var(--p);color:rgba(255,255,255,.5);text-align:center;padding:20px;font-size:.8rem;margin-top:32px}
</style>
</head>
<body>
<header>
  <div class="logo"><div class="logo-icon">üë∑</div>‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡πà‡∏≤‡∏á</div>
  <nav class="nav">
    <a href="../index.html">‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</a>
    <a href="../admin/index.html">Admin</a>
    <a href="index.html" class="active">‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡πà‡∏≤‡∏á</a>
  </nav>
</header>

<!-- LOGIN -->
<div class="login-wrap" id="loginWrap">
  <div class="login-card">
    <div class="login-icon">üë∑</div>
    <div class="login-title">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡πà‡∏≤‡∏á</div>
    <div class="login-sub">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢</div>
    <div class="fg" style="text-align:left">
      <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≤‡∏á</label>
      <select id="techSelect"></select>
    </div>
    <button class="btn btn-primary" onclick="loginTech()">üîì ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    <div style="margin-top:14px;font-size:.8rem;color:var(--muted)">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠? ‡πÉ‡∏´‡πâ Admin ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≤‡∏á‡πÉ‡∏ô Admin Panel</div>
  </div>
</div>

<!-- DASHBOARD -->
<div class="container" id="dashboard" style="display:none">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
    <div>
      <h2 style="font-family:Kanit,sans-serif;font-weight:700;color:var(--p)" id="techGreeting"></h2>
      <div style="font-size:.88rem;color:var(--muted)" id="techSubtitle"></div>
    </div>
    <button class="btn btn-sm" style="background:var(--border);color:var(--text)" onclick="logout()">üö™ ‡∏≠‡∏≠‡∏Å</button>
  </div>

  <!-- STATS -->
  <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:22px">
    <div class="card" style="padding:16px;display:flex;align-items:center;gap:12px">
      <div style="font-size:1.8rem">üìã</div>
      <div><div style="font-family:Kanit,sans-serif;font-size:1.6rem;font-weight:700;color:var(--p)" id="myTotal">0</div><div style="font-size:.78rem;color:var(--muted)">‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div>
    </div>
    <div class="card" style="padding:16px;display:flex;align-items:center;gap:12px">
      <div style="font-size:1.8rem">üîß</div>
      <div><div style="font-family:Kanit,sans-serif;font-size:1.6rem;font-weight:700;color:var(--p)" id="myActive">0</div><div style="font-size:.78rem;color:var(--muted)">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div></div>
    </div>
    <div class="card" style="padding:16px;display:flex;align-items:center;gap:12px">
      <div style="font-size:1.8rem">‚úÖ</div>
      <div><div style="font-family:Kanit,sans-serif;font-size:1.6rem;font-weight:700;color:var(--p)" id="myDone">0</div><div style="font-size:.78rem;color:var(--muted)">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</div></div>
    </div>
  </div>

  <!-- JOBS -->
  <div class="card">
    <div class="card-title"><span>üóÇÔ∏è</span> ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢</div>
    <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap">
      <button class="btn btn-sm" id="fAll" onclick="setFilter('')" style="background:var(--p);color:#fff">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      <button class="btn btn-sm" id="fPend" onclick="setFilter('assigned')" style="background:var(--bg);color:var(--text)">‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</button>
      <button class="btn btn-sm" id="fIP" onclick="setFilter('inprogress')" style="background:var(--bg);color:var(--text)">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°</button>
      <button class="btn btn-sm" id="fDone" onclick="setFilter('done')" style="background:var(--bg);color:var(--text)">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
    </div>
    <div id="jobList"></div>
  </div>
</div>

<!-- MODAL DETAIL -->
<div class="modal-overlay" id="modalO" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <button class="modal-close" onclick="closeModal()">‚úï ‡∏õ‡∏¥‡∏î</button>
    <div style="font-family:Kanit,sans-serif;font-weight:700;color:var(--p);font-size:1.05rem;margin-bottom:16px">üîß ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô</div>
    <div id="modalBody"></div>
  </div>
</div>

<div id="lightbox"><button class="lb-close" onclick="document.getElementById('lightbox').classList.remove('open')">‚úï</button><img id="lbImg"></div>
<div class="toast" id="toast"></div>
<footer>¬© 2025 ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° ‚Äî ‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡πà‡∏≤‡∏á</footer>

<script src="../js/db.js"></script>
<script src="../js/notify.js"></script>
<script>
let currentTechId = null;
let filterStatus = '';
let currentJobId = null;
let afterImgsLocal = [];

/* LOGIN */
function initLogin() {
  const techs = DB.getTechs().filter(t=>t.active);
  const sel = document.getElementById('techSelect');
  sel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≤‡∏á --</option>' +
    techs.map(t=>`<option value="${t.id}">üë∑ ${t.name}${t.skill?' ('+t.skill+')':''}</option>`).join('');
}

function loginTech() {
  const id = document.getElementById('techSelect').value;
  if (!id) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≤‡∏á','error'); return; }
  currentTechId = id;
  document.getElementById('loginWrap').style.display = 'none';
  document.getElementById('dashboard').style.display = 'block';
  renderDashboard();
}

function logout() {
  currentTechId = null;
  document.getElementById('loginWrap').style.display = 'flex';
  document.getElementById('dashboard').style.display = 'none';
}

/* DASHBOARD */
function renderDashboard() {
  const tech = DB.getTechById(currentTechId);
  if (!tech) return;
  document.getElementById('techGreeting').textContent = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ üë∑ ${tech.name}`;
  document.getElementById('techSubtitle').textContent = `${tech.skill||'‡∏ä‡πà‡∏≤‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'}${tech.phone?' ¬∑ '+tech.phone:''}`;

  const myJobs = DB.getAll().filter(t=>t.technicianId===currentTechId);
  document.getElementById('myTotal').textContent  = myJobs.length;
  document.getElementById('myActive').textContent = myJobs.filter(t=>t.status!=='done').length;
  document.getElementById('myDone').textContent   = myJobs.filter(t=>t.status==='done').length;
  renderJobs();
}

function setFilter(s) {
  filterStatus = s;
  ['fAll','fPend','fIP','fDone'].forEach(id=>document.getElementById(id).style.cssText='background:var(--bg);color:var(--text)');
  const map={'':'fAll','assigned':'fPend','inprogress':'fIP','done':'fDone'};
  const btn = document.getElementById(map[s]);
  if(btn) btn.style.cssText='background:var(--p);color:#fff';
  renderJobs();
}

function renderJobs() {
  let jobs = DB.getAll().filter(t=>t.technicianId===currentTechId);
  if (filterStatus) jobs = jobs.filter(t=>t.status===filterStatus);
  jobs.sort((a,b)=>{ const o={high:0,medium:1,low:2}; return (o[a.priority]-o[b.priority])||new Date(b.createdAt)-new Date(a.createdAt); });

  const el = document.getElementById('jobList');
  if (!jobs.length) { el.innerHTML='<div style="text-align:center;padding:32px;color:var(--muted)">üì≠ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</div>'; return; }
  el.innerHTML = jobs.map(t => `
    <div class="job-card ${t.priority==='high'?'urgent':t.priority==='medium'?'medium':''}">
      <div class="job-header">
        <div>
          <div class="job-id">${t.id} ¬∑ ${fmtDate(t.createdAt)}</div>
          <div class="job-title">üìç ${t.location}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:4px;align-items:flex-end">
          <span class="badge badge-${t.status}">${DB.statusLabel(t.status)}</span>
          <span class="badge badge-${t.priority}">${DB.priorityLabel(t.priority)}</span>
        </div>
      </div>
      <div class="job-meta">üî© ${DB.categoryLabel(t.category)} ¬∑ üë§ ${t.name} ¬∑ üìû ${t.phone}</div>
      <div style="font-size:.85rem;margin-bottom:10px;color:var(--text)">${t.description.length>80?t.description.slice(0,80)+'...':t.description}</div>
      <div style="display:flex;gap:7px;flex-wrap:wrap">
        <button class="btn btn-primary btn-sm" onclick="openJob('${t.id}')">üîç ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
        ${t.status==='assigned'?`<button class="btn btn-warning btn-sm" onclick="quickStatus('${t.id}','inprogress')">‚ñ∂Ô∏è ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</button>`:''}
        ${t.status==='inprogress'?`<button class="btn btn-success btn-sm" onclick="openJob('${t.id}')">‚úÖ ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</button>`:''}
      </div>
    </div>`).join('');
}

async function quickStatus(id, status) {
  DB.updateStatus(id, status, status==='inprogress'?'‡∏ä‡πà‡∏≤‡∏á‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß':'', 'technician');
  const t = DB.getById(id);
  await NOTIFY.sendAll(t, status, '', DB.getSettings().adminEmail);
  renderDashboard();
  showToast(status==='inprogress'?'‚ñ∂Ô∏è ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£':'‚úÖ ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','success');
}

function openJob(id) {
  currentJobId = id;
  afterImgsLocal = [];
  const t = DB.getById(id);
  if (!t) return;
  let html = `
    <div class="det-row"><span class="det-lbl">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç</span><span class="det-val">${t.id}</span></div>
    <div class="det-row"><span class="det-lbl">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span><span class="det-val"><span class="badge badge-${t.status}">${DB.statusLabel(t.status)}</span></span></div>
    <div class="det-row"><span class="det-lbl">‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</span><span class="det-val">${t.name} (${t.phone})</span></div>
    <div class="det-row"><span class="det-lbl">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</span><span class="det-val">${t.location}</span></div>
    <div class="det-row"><span class="det-lbl">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</span><span class="det-val">${DB.categoryLabel(t.category)}</span></div>
    <div class="det-row" style="flex-direction:column;gap:4px"><span class="det-lbl">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span><span>${t.description}</span></div>`;

  if (t.imagesBefore?.length) {
    html+=`<div style="margin-top:10px"><strong style="font-size:.84rem">üì∑ ‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏ã‡πà‡∏≠‡∏°</strong>
    <div class="gallery-grid">${t.imagesBefore.map(s=>`<img src="${s}" onclick="openLB('${s}')">`).join('')}</div></div>`;
  }
  if (t.imagesAfter?.length) {
    html+=`<div style="margin-top:10px"><strong style="font-size:.84rem">‚úÖ ‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°</strong>
    <div class="gallery-grid">${t.imagesAfter.map(s=>`<img src="${s}" onclick="openLB('${s}')">`).join('')}</div></div>`;
  }

  if (t.status !== 'done') {
    html += `<div style="margin-top:14px;padding-top:14px;border-top:2px solid var(--border)">
      <label>üì∑ ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°</label>
      <div class="img-upload-zone"><input type="file" accept="image/*" multiple onchange="handleTechAfter(this)">üìÅ ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°</div>
      <div class="img-preview-grid" id="prevAfterTech"></div>

      <div class="fg" style="margin-top:12px"><label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ / ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°</label><textarea id="techNote" placeholder="‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°..."></textarea></div>
      <div style="display:flex;gap:8px;margin-top:4px">
        ${t.status==='assigned'?`<button class="btn btn-warning" onclick="techAction('inprogress')">‚ñ∂Ô∏è ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</button>`:''}
        ${t.status==='inprogress'?`<button class="btn btn-success" onclick="techAction('done')">‚úÖ ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</button>`:''}
      </div>
    </div>`;
  }

  html += `<div class="timeline"><div style="font-weight:700;font-size:.84rem;margin-bottom:8px;color:var(--p)">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>
    ${t.history.slice().reverse().map(h=>`<div class="t-item"><div class="t-dot"></div>
    <div><strong>${h.note}</strong><br><span style="color:var(--muted)">${fmtDate(h.date)}</span></div></div>`).join('')}</div>`;

  document.getElementById('modalBody').innerHTML = html;
  document.getElementById('modalO').classList.add('open');
}

function handleTechAfter(input) {
  Array.from(input.files).slice(0,5).forEach(f=>{
    const r=new FileReader();
    r.onload=e=>{
      afterImgsLocal.push(e.target.result);
      document.getElementById('prevAfterTech').innerHTML=afterImgsLocal.map((s,i)=>`
        <div class="img-thumb"><img src="${s}" onclick="openLB('${s}')">
        <button class="del-img" onclick="afterImgsLocal.splice(${i},1)">‚úï</button></div>`).join('');
    };
    r.readAsDataURL(f);
  });
}

async function techAction(newStatus) {
  const note = document.getElementById('techNote')?.value||'';
  if (afterImgsLocal.length) DB.addImages(currentJobId,'after',afterImgsLocal);
  DB.updateStatus(currentJobId, newStatus, note||(newStatus==='inprogress'?'‡∏ä‡πà‡∏≤‡∏á‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß':'‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'), 'technician');
  const t = DB.getById(currentJobId);
  await NOTIFY.sendAll(t, newStatus, note, t.email||DB.getSettings().adminEmail);
  closeModal();
  renderDashboard();
  showToast(newStatus==='done'?'‚úÖ ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!':'‚ñ∂Ô∏è ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß!','success');
}

function closeModal(){document.getElementById('modalO').classList.remove('open')}
function openLB(src){document.getElementById('lbImg').src=src;document.getElementById('lightbox').classList.add('open')}
function showToast(msg,type='success'){const e=document.getElementById('toast');e.textContent=msg;e.className=`toast ${type} show`;setTimeout(()=>e.className='toast',3500)}
function fmtDate(iso){if(!iso)return'-';return new Date(iso).toLocaleString('th-TH',{year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'})}

document.getElementById('lightbox').addEventListener('click',e=>{if(e.target===document.getElementById('lightbox'))document.getElementById('lightbox').classList.remove('open')});
initLogin();
</script>
</body>
</html>
