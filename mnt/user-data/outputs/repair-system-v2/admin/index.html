<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel | ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Kanit:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--p:#0A2342;--p2:#1B4F8A;--acc:#F4A926;--ok:#27AE60;--err:#E74C3C;--bg:#EEF2F7;--card:#fff;--text:#1A2B3C;--muted:#7A8DA0;--border:#D1DCE8;--sh:0 4px 24px rgba(10,35,66,.10)}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Sarabun',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
header{background:var(--p);color:#fff;padding:0 32px;display:flex;align-items:center;justify-content:space-between;height:66px;box-shadow:0 2px 16px rgba(10,35,66,.18);position:sticky;top:0;z-index:100}
.logo{font-family:'Kanit',sans-serif;font-size:1.3rem;font-weight:700;display:flex;align-items:center;gap:10px}
.logo-icon{width:36px;height:36px;background:var(--acc);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:1.1rem}
.nav a{color:rgba(255,255,255,.75);text-decoration:none;margin-left:22px;font-size:.9rem;transition:color .2s}
.nav a:hover,.nav a.active{color:var(--acc)}
.container{max-width:1280px;margin:0 auto;padding:28px 18px}
/* TABS */
.tabs{display:flex;gap:4px;margin-bottom:24px;background:var(--card);padding:6px;border-radius:14px;box-shadow:var(--sh)}
.tab{flex:1;padding:10px;border:none;border-radius:10px;font-family:'Sarabun',sans-serif;font-size:.9rem;font-weight:700;cursor:pointer;background:transparent;color:var(--muted);transition:all .2s}
.tab.active{background:var(--p);color:#fff}
.tab-panel{display:none}.tab-panel.active{display:block}
/* STATS */
.stats-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:14px;margin-bottom:24px}
.stat-card{background:var(--card);border-radius:14px;padding:18px 20px;box-shadow:var(--sh);display:flex;align-items:center;gap:14px}
.stat-icon{font-size:1.8rem}
.stat-num{font-family:'Kanit',sans-serif;font-size:1.6rem;font-weight:700;color:var(--p)}
.stat-label{font-size:.78rem;color:var(--muted);font-weight:500}
/* CARD */
.card{background:var(--card);border-radius:16px;box-shadow:var(--sh);padding:24px;margin-bottom:22px}
.card-title{font-family:'Kanit',sans-serif;font-size:1.05rem;font-weight:700;color:var(--p);margin-bottom:18px;display:flex;align-items:center;gap:8px}
/* TABLE */
.toolbar{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap}
input[type=text],select,input[type=email],input[type=tel]{padding:9px 13px;border:1.5px solid var(--border);border-radius:9px;font-family:'Sarabun',sans-serif;font-size:.9rem;color:var(--text);background:#fafbfd;outline:none;transition:border-color .2s}
input[type=text]:focus,select:focus{border-color:var(--p)}
input[type=text]{flex:1;min-width:160px}
.btn{display:inline-flex;align-items:center;gap:6px;padding:9px 16px;border:none;border-radius:9px;font-family:'Sarabun',sans-serif;font-size:.88rem;font-weight:700;cursor:pointer;transition:all .2s;white-space:nowrap}
.btn:hover{opacity:.88;transform:translateY(-1px)}
.btn-primary{background:var(--p);color:#fff}
.btn-success{background:var(--ok);color:#fff}
.btn-warning{background:var(--acc);color:var(--p)}
.btn-danger{background:var(--err);color:#fff}
.btn-info{background:#0EA5E9;color:#fff}
.btn-sm{padding:5px 11px;font-size:.8rem;border-radius:7px}
table{width:100%;border-collapse:collapse}
th{background:var(--bg);padding:10px 12px;text-align:left;font-size:.78rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.05em}
td{padding:12px 12px;border-bottom:1px solid var(--border);font-size:.87rem;vertical-align:middle}
tr:last-child td{border-bottom:none}
tr:hover td{background:#F8FAFC}
.actions{display:flex;gap:5px;flex-wrap:wrap}
/* BADGE */
.badge{display:inline-block;padding:3px 9px;border-radius:18px;font-size:.72rem;font-weight:700;white-space:nowrap}
.badge-pending{background:#FFF3CD;color:#856404}
.badge-assigned{background:#E8D5FF;color:#6B21A8}
.badge-inprogress{background:#CCE5FF;color:#0056B3}
.badge-done{background:#D4EDDA;color:#155724}
.badge-low{background:#EDFBF4;color:#27AE60}
.badge-medium{background:#FFF8EC;color:#D68910}
.badge-high{background:#FEECEB;color:#E74C3C}
/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:300;display:flex;align-items:center;justify-content:center;padding:16px;opacity:0;pointer-events:none;transition:opacity .3s}
.modal-overlay.open{opacity:1;pointer-events:all}
.modal{background:#fff;border-radius:16px;padding:28px;max-width:580px;width:100%;max-height:92vh;overflow-y:auto;transform:scale(.93);transition:transform .3s}
.modal-overlay.open .modal{transform:scale(1)}
.modal-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
.modal-close{width:30px;height:30px;border:none;background:var(--bg);border-radius:7px;cursor:pointer;font-size:.95rem;display:flex;align-items:center;justify-content:center;color:var(--muted)}
.modal-close:hover{background:var(--border)}
.fg{margin-bottom:14px}
label{display:block;font-size:.85rem;font-weight:700;margin-bottom:5px}
.det-row{display:flex;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--border);font-size:.87rem}
.det-row:last-child{border-bottom:none}
.det-lbl{color:var(--muted);font-weight:500}.det-val{font-weight:700;text-align:right;max-width:58%}
textarea{width:100%;padding:9px 13px;border:1.5px solid var(--border);border-radius:9px;font-family:'Sarabun',sans-serif;font-size:.9rem;color:var(--text);resize:vertical;outline:none;min-height:70px}
textarea:focus{border-color:var(--p)}
.gallery-grid{display:flex;flex-wrap:wrap;gap:7px;margin-top:8px}
.gallery-grid img{width:76px;height:76px;object-fit:cover;border-radius:8px;border:2px solid var(--border);cursor:pointer}
.timeline{margin-top:12px;padding:12px;background:var(--bg);border-radius:10px}
.t-item{display:flex;gap:9px;margin-bottom:8px;font-size:.8rem}
.t-dot{width:7px;height:7px;background:var(--p);border-radius:50%;margin-top:4px;flex-shrink:0}
.img-upload-zone{border:2px dashed var(--border);border-radius:10px;padding:16px;text-align:center;cursor:pointer;position:relative;transition:all .2s}
.img-upload-zone:hover{border-color:var(--p)}
.img-upload-zone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.img-preview-grid{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.img-thumb{position:relative;width:64px;height:64px;border-radius:7px;overflow:hidden;border:2px solid var(--border)}
.img-thumb img{width:100%;height:100%;object-fit:cover}
.img-thumb .del-img{position:absolute;top:1px;right:1px;background:rgba(0,0,0,.6);color:#fff;border:none;border-radius:50%;width:16px;height:16px;font-size:.65rem;cursor:pointer;display:flex;align-items:center;justify-content:center}
/* SETTINGS FORM */
.settings-section{margin-bottom:24px;padding-bottom:20px;border-bottom:2px solid var(--border)}
.settings-section:last-child{border-bottom:none}
.settings-title{font-family:'Kanit',sans-serif;font-weight:700;color:var(--p);margin-bottom:14px;font-size:1rem}
.grid-2s{display:grid;grid-template-columns:1fr 1fr;gap:12px}
/* NOTIFY LOG */
.nlog{font-size:.78rem;background:var(--bg);padding:8px 12px;border-radius:8px;margin-top:8px;max-height:100px;overflow-y:auto;font-family:monospace;white-space:pre-wrap;color:var(--text)}
/* TECH CARD */
.tech-card{border:1.5px solid var(--border);border-radius:12px;padding:14px 16px;display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;transition:all .2s}
.tech-card:hover{border-color:var(--p)}
.tech-avatar{width:40px;height:40px;background:var(--p);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Kanit',sans-serif;font-weight:700;font-size:1.1rem;flex-shrink:0}
.tech-info{flex:1;margin-left:12px}
.tech-name{font-weight:700}
.tech-meta{font-size:.8rem;color:var(--muted)}
.workload-bar{height:5px;background:var(--border);border-radius:3px;margin-top:5px;width:120px}
.workload-fill{height:100%;border-radius:3px;background:var(--ok)}
/* TOAST */
.toast{position:fixed;top:80px;right:18px;padding:13px 20px;border-radius:11px;font-weight:700;transform:translateX(200%);transition:transform .4s cubic-bezier(.34,1.56,.64,1);z-index:999;max-width:300px;font-size:.9rem}
.toast.success{background:var(--ok);color:#fff}.toast.error{background:var(--err);color:#fff}.toast.info{background:var(--p);color:#fff}
.toast.show{transform:translateX(0)}
/* LIGHTBOX */
#lightbox{position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:500;display:none;align-items:center;justify-content:center}
#lightbox.open{display:flex}
#lightbox img{max-width:92vw;max-height:92vh;border-radius:10px}
#lightbox .lb-close{position:absolute;top:20px;right:24px;color:#fff;font-size:2rem;cursor:pointer;background:none;border:none}
footer{background:var(--p);color:rgba(255,255,255,.5);text-align:center;padding:20px;font-size:.8rem;margin-top:32px}
@media(max-width:900px){.stats-grid{grid-template-columns:repeat(2,1fr)}.grid-2s{grid-template-columns:1fr}}
@media(max-width:600px){header{padding:0 14px}.tabs{flex-wrap:wrap}table{font-size:.78rem}}
</style>
</head>
<body>
<header>
  <div class="logo"><div class="logo-icon">üîß</div>Admin Panel</div>
  <nav class="nav">
    <a href="../index.html">‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</a>
    <a href="../status.html">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</a>
    <a href="index.html" class="active">Admin</a>
    <a href="../technician/index.html">‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡πà‡∏≤‡∏á</a>
  </nav>
</header>

<div class="container">
  <!-- STATS -->
  <div class="stats-grid" id="statsGrid">
    <div class="stat-card"><div class="stat-icon">üìã</div><div><div class="stat-num" id="sTotal">0</div><div class="stat-label">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div></div>
    <div class="stat-card"><div class="stat-icon">‚è≥</div><div><div class="stat-num" id="sPend">0</div><div class="stat-label">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div></div></div>
    <div class="stat-card"><div class="stat-icon">üë∑</div><div><div class="stat-num" id="sAssign">0</div><div class="stat-label">‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</div></div></div>
    <div class="stat-card"><div class="stat-icon">üîß</div><div><div class="stat-num" id="sIP">0</div><div class="stat-label">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°</div></div></div>
    <div class="stat-card"><div class="stat-icon">‚≠ê</div><div><div class="stat-num" id="sRating">-</div><div class="stat-label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div></div></div>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <button class="tab active" onclick="switchTab('tickets')">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°</button>
    <button class="tab" onclick="switchTab('technicians')">üë∑ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡πà‡∏≤‡∏á</button>
    <button class="tab" onclick="switchTab('settings')">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</button>
  </div>

  <!-- TAB: TICKETS -->
  <div class="tab-panel active" id="tab-tickets">
    <div class="card">
      <div class="card-title"><span>üìã</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
      <div class="toolbar">
        <input type="text" id="searchQ" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." oninput="renderTable()">
        <select id="fStatus" onchange="renderTable()">
          <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
          <option value="pending">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
          <option value="assigned">‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</option>
          <option value="inprogress">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°</option>
          <option value="done">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</option>
        </select>
        <select id="fPriority" onchange="renderTable()">
          <option value="">‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö</option>
          <option value="high">‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å</option>
          <option value="medium">‡∏î‡πà‡∏ß‡∏ô</option>
          <option value="low">‡∏õ‡∏Å‡∏ï‡∏¥</option>
        </select>
        <button class="btn btn-danger btn-sm" onclick="if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')){DB.deleteAll();renderAll();showToast('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß','error')}">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        <button class="btn btn-info btn-sm" onclick="exportCSV()">üìä Export CSV</button>
      </div>
      <div style="overflow-x:auto">
        <table>
          <thead><tr>
            <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç</th><th>‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
            <th>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô</th><th>‡∏ä‡πà‡∏≤‡∏á</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
          </tr></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
      <div id="emptyMsg"></div>
    </div>
  </div>

  <!-- TAB: TECHNICIANS -->
  <div class="tab-panel" id="tab-technicians">
    <div class="card">
      <div class="card-title"><span>üë∑</span> ‡∏ó‡∏µ‡∏°‡∏ä‡πà‡∏≤‡∏á</div>
      <button class="btn btn-primary btn-sm" onclick="openAddTech()" style="margin-bottom:16px">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà</button>
      <div id="techList"></div>
    </div>
  </div>

  <!-- TAB: SETTINGS -->
  <div class="tab-panel" id="tab-settings">
    <div class="card">
      <div class="card-title"><span>‚öôÔ∏è</span> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>

      <div class="settings-section">
        <div class="settings-title">üè¢ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£</div>
        <div class="fg"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£ / ‡∏£‡∏∞‡∏ö‡∏ö</label><input type="text" id="sOrgName" placeholder="‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå"></div>
        <div class="fg"><label>‡∏≠‡∏µ‡πÄ‡∏°‡∏• Admin</label><input type="email" id="sAdminEmail" placeholder="admin@example.com"></div>
      </div>

      <div class="settings-section">
        <div class="settings-title">üì± Telegram Bot</div>
        <div class="grid-2s">
          <div class="fg"><label>Bot Token</label><input type="text" id="sTgToken" placeholder="123456789:AABBCCddEEff..."></div>
          <div class="fg"><label>Chat ID (‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß)</label><input type="text" id="sTgChat" placeholder="-1001234567890 ‡∏´‡∏£‡∏∑‡∏≠ 123456789"></div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
          <button class="btn btn-info btn-sm" onclick="testTg()">üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Telegram</button>
          <span id="tgResult" style="font-size:.82rem;color:var(--muted)"></span>
        </div>
        <div class="nlog" id="tgLog"></div>
        <details style="margin-top:12px"><summary style="cursor:pointer;font-size:.85rem;font-weight:700;color:var(--p)">üìñ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏™‡∏£‡πâ‡∏≤‡∏á Telegram Bot</summary>
        <div style="font-size:.83rem;line-height:1.7;margin-top:8px;color:var(--muted)">
          1. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ <strong>@BotFather</strong> ‡πÉ‡∏ô Telegram<br>
          2. ‡∏û‡∏¥‡∏°‡∏û‡πå <code>/newbot</code> ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠ Bot<br>
          3. ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å <strong>Bot Token</strong> ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡πÉ‡∏ô input ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô<br>
          4. ‡πÄ‡∏û‡∏¥‡πà‡∏° Bot ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πà‡∏á message ‡∏´‡∏≤ Bot ‡∏Å‡πà‡∏≠‡∏ô<br>
          5. ‡πÄ‡∏õ‡∏¥‡∏î URL: <code>https://api.telegram.org/bot[TOKEN]/getUpdates</code><br>
          6. ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å <strong>chat.id</strong> ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡πÉ‡∏ô Chat ID
        </div></details>
      </div>

      <div class="settings-section">
        <div class="settings-title">üîó Webhook URL</div>
        <div class="fg"><label>Webhook Endpoint (POST JSON)</label><input type="text" id="sWebhook" placeholder="https://hooks.zapier.com/... ‡∏´‡∏£‡∏∑‡∏≠ n8n, Make.com"></div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
          <button class="btn btn-info btn-sm" onclick="testWh()">üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Webhook</button>
          <span id="whResult" style="font-size:.82rem;color:var(--muted)"></span>
        </div>
        <div class="nlog" id="whLog"></div>
      </div>

      <div class="settings-section">
        <div class="settings-title">üìß Gmail via Google Apps Script</div>
        <div class="fg"><label>Google Apps Script URL (Web App URL)</label><input type="text" id="sGasUrl" placeholder="https://script.google.com/macros/s/xxxxx/exec"></div>
        <details style="margin-top:8px"><summary style="cursor:pointer;font-size:.85rem;font-weight:700;color:var(--p)">üìñ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Apps Script</summary>
        <div style="font-size:.83rem;line-height:1.8;margin-top:8px;color:var(--muted)">
          1. ‡πÑ‡∏õ‡∏ó‡∏µ‡πà <a href="https://script.google.com" target="_blank" style="color:var(--p2)">script.google.com</a> ‚Üí New Project<br>
          2. ‡∏ß‡∏≤‡∏á code ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå <strong>gas/Code.gs</strong> ‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏ô‡∏µ‡πâ<br>
          3. ‡∏Å‡∏î <strong>Deploy ‚Üí New deployment ‚Üí Web App</strong><br>
          4. ‡∏ï‡∏±‡πâ‡∏á Execute as: <strong>Me</strong>, Who has access: <strong>Anyone</strong><br>
          5. ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å <strong>Web App URL</strong> ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô<br>
          6. ‡πÄ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô/‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô Email ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö!
        </div></details>
      </div>

      <div class="settings-section">
        <div class="settings-title">üîî ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
        <div style="display:flex;flex-direction:column;gap:10px">
          <label style="display:flex;align-items:center;gap:10px;font-weight:400;cursor:pointer">
            <input type="checkbox" id="sNotifyNew" style="width:auto"> ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÉ‡∏´‡∏°‡πà
          </label>
          <label style="display:flex;align-items:center;gap:10px;font-weight:400;cursor:pointer">
            <input type="checkbox" id="sNotifyAssign" style="width:auto"> ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≤‡∏á
          </label>
          <label style="display:flex;align-items:center;gap:10px;font-weight:400;cursor:pointer">
            <input type="checkbox" id="sNotifyDone" style="width:auto"> ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à
          </label>
          <label style="display:flex;align-items:center;gap:10px;font-weight:400;cursor:pointer">
            <input type="checkbox" id="sNotifyRating" style="width:auto"> ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
          </label>
        </div>
      </div>

      <button class="btn btn-success" onclick="saveSettings()" style="width:100%">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
    </div>
  </div>
</div>

<!-- MODAL: EDIT TICKET -->
<div class="modal-overlay" id="modalO" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <div class="modal-hd">
      <span style="font-family:Kanit,sans-serif;font-weight:700;color:var(--p);font-size:1rem">üîß ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</span>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<!-- MODAL: ADD TECH -->
<div class="modal-overlay" id="techModal" onclick="if(event.target===this)closeTechModal()">
  <div class="modal" style="max-width:420px">
    <div class="modal-hd">
      <span style="font-family:Kanit,sans-serif;font-weight:700;color:var(--p);font-size:1rem" id="techModalTitle">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà</span>
      <button class="modal-close" onclick="closeTechModal()">‚úï</button>
    </div>
    <div class="fg"><label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• *</label><input type="text" id="tName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≤‡∏á"></div>
    <div class="fg"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå *</label><input type="tel" id="tPhone" placeholder="0xx-xxx-xxxx"></div>
    <div class="fg"><label>‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô)</label><input type="email" id="tEmail" placeholder="tech@email.com"></div>
    <div class="fg"><label>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç</label><input type="text" id="tSkill" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤, ‡∏õ‡∏£‡∏∞‡∏õ‡∏≤, ‡πÅ‡∏≠‡∏£‡πå"></div>
    <div class="fg"><label>Line ID / Telegram</label><input type="text" id="tContact" placeholder="@lineId ‡∏´‡∏£‡∏∑‡∏≠ @telegram"></div>
    <button class="btn btn-primary" onclick="saveTech()" style="width:100%">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
  </div>
</div>

<!-- LIGHTBOX -->
<div id="lightbox"><button class="lb-close" onclick="document.getElementById('lightbox').classList.remove('open')">‚úï</button><img id="lbImg" src=""></div>
<div class="toast" id="toast"></div>
<footer>¬© 2025 ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° Admin Panel v2</footer>

<script src="../js/db.js"></script>
<script src="../js/notify.js"></script>
<script>
let currentId = null;
let techEditId = null;
let afterImgs = [];

/* TABS */
function switchTab(name) {
  document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('active',['tickets','technicians','settings'][i]===name));
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  if(name==='technicians') renderTechs();
  if(name==='settings') loadSettings();
}

/* STATS + TABLE */
function renderAll() {
  const s = DB.stats();
  document.getElementById('sTotal').textContent  = s.total;
  document.getElementById('sPend').textContent   = s.pending;
  document.getElementById('sAssign').textContent = s.assigned;
  document.getElementById('sIP').textContent     = s.inprogress;
  document.getElementById('sRating').textContent = s.avgRating;
  renderTable();
}

function renderTable() {
  const q  = document.getElementById('searchQ').value.toLowerCase();
  const st = document.getElementById('fStatus').value;
  const pr = document.getElementById('fPriority').value;
  let tickets = DB.getAll();
  if (q)  tickets = tickets.filter(t=>[t.id,t.name,t.location,t.phone].some(f=>f?.toLowerCase().includes(q)));
  if (st) tickets = tickets.filter(t=>t.status===st);
  if (pr) tickets = tickets.filter(t=>t.priority===pr);

  const body = document.getElementById('tableBody');
  if (!tickets.length) {
    body.innerHTML='';
    document.getElementById('emptyMsg').innerHTML='<div style="text-align:center;padding:32px;color:var(--muted)">üì≠ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>';
    return;
  }
  document.getElementById('emptyMsg').innerHTML='';
  body.innerHTML = tickets.map(t => {
    const tech = t.technicianId ? DB.getTechById(t.technicianId) : null;
    return `<tr>
      <td><strong>${t.id}</strong>
        ${t.imagesBefore?.length?`<br><span style="font-size:.7rem;color:#0EA5E9">üì∑B:${t.imagesBefore.length}</span>`:''}
        ${t.imagesAfter?.length?`<span style="font-size:.7rem;color:#27AE60"> A:${t.imagesAfter.length}</span>`:''}
      </td>
      <td>${t.name}<br><small style="color:var(--muted)">${t.phone}</small></td>
      <td>${t.location}</td>
      <td style="font-size:.82rem">${DB.categoryLabel(t.category)}</td>
      <td><span class="badge badge-${t.priority}">${DB.priorityLabel(t.priority)}</span></td>
      <td>${tech?`<span style="font-size:.82rem">üë∑${tech.name}</span>`:'<span style="color:var(--muted);font-size:.8rem">-</span>'}</td>
      <td>${t.rating?`‚≠ê${t.rating}`:'<span style="color:var(--muted)">-</span>'}</td>
      <td style="font-size:.78rem">${fmtDate(t.createdAt)}</td>
      <td><span class="badge badge-${t.status}">${DB.statusLabel(t.status)}</span></td>
      <td><div class="actions">
        <button class="btn btn-primary btn-sm" onclick="openEdit('${t.id}')">‚úèÔ∏è</button>
        <button class="btn btn-danger btn-sm" onclick="delTicket('${t.id}')">üóëÔ∏è</button>
      </div></td>
    </tr>`;
  }).join('');
}

/* EDIT MODAL */
function openEdit(id) {
  currentId = id; afterImgs = [];
  const t = DB.getById(id);
  if (!t) return;
  const tech = t.technicianId ? DB.getTechById(t.technicianId) : null;
  const techs = DB.getTechs().filter(t=>t.active);

  let html = `
    <div class="det-row"><span class="det-lbl">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç</span><span class="det-val">${t.id}</span></div>
    <div class="det-row"><span class="det-lbl">‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</span><span class="det-val">${t.name} (${t.phone})</span></div>
    <div class="det-row"><span class="det-lbl">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</span><span class="det-val">${t.location}</span></div>
    <div class="det-row"><span class="det-lbl">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</span><span class="det-val">${DB.categoryLabel(t.category)}</span></div>
    <div class="det-row" style="flex-direction:column;gap:4px"><span class="det-lbl">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span><span>${t.description}</span></div>`;

  // ‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô
  if (t.imagesBefore?.length) {
    html+=`<div style="margin-top:10px"><strong style="font-size:.84rem">üì∑ ‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏ã‡πà‡∏≠‡∏°</strong>
    <div class="gallery-grid">${t.imagesBefore.map(s=>`<img src="${s}" onclick="openLB('${s}')">`).join('')}</div></div>`;
  }
  // ‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á
  if (t.imagesAfter?.length) {
    html+=`<div style="margin-top:10px"><strong style="font-size:.84rem">‚úÖ ‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°</strong>
    <div class="gallery-grid">${t.imagesAfter.map(s=>`<img src="${s}" onclick="openLB('${s}')">`).join('')}</div></div>`;
  }
  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°
  html+=`<div style="margin-top:12px"><label>üì∑ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°</label>
  <div class="img-upload-zone"><input type="file" accept="image/*" multiple onchange="handleAfterImgs(this)">üìÅ ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°</div>
  <div class="img-preview-grid" id="prevAfter"></div></div>`;

  // ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏ä‡πà‡∏≤‡∏á
  html += `<div style="margin-top:14px;padding-top:14px;border-top:2px solid var(--border)">
    <div class="fg"><label>üë∑ ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏ä‡πà‡∏≤‡∏á</label>
    <select id="newTech" style="width:100%">
      <option value="">-- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢ --</option>
      ${techs.map(t=>`<option value="${t.id}" ${t.id===tech?.id?'selected':''}>${t.name} (${t.skill||'‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'}) ‚Äî ‡∏á‡∏≤‡∏ô: ${DB.techWorkload(t.id)}</option>`).join('')}
    </select></div>

    <div class="fg"><label>‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
    <select id="newStatus" style="width:100%">
      <option value="pending"    ${t.status==='pending'   ?'selected':''}>‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
      <option value="assigned"   ${t.status==='assigned'  ?'selected':''}>üë∑ ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</option>
      <option value="inprogress" ${t.status==='inprogress'?'selected':''}>üîß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°</option>
      <option value="done"       ${t.status==='done'      ?'selected':''}>‚úÖ ‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à</option>
    </select></div>

    <div class="fg"><label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><textarea id="newNote" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..."></textarea></div>
    <button class="btn btn-success" style="width:100%" onclick="saveEdit()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å & ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</button>
  </div>`;

  // Timeline
  html += `<div class="timeline" style="margin-top:14px">
    <div style="font-weight:700;font-size:.84rem;margin-bottom:8px;color:var(--p)">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>
    ${t.history.slice().reverse().map(h=>`
      <div class="t-item"><div class="t-dot"></div>
      <div><strong>${h.note}</strong><br><span style="color:var(--muted)">${fmtDate(h.date)}</span></div></div>`).join('')}
  </div>`;

  document.getElementById('modalBody').innerHTML = html;
  document.getElementById('modalO').classList.add('open');
}

function handleAfterImgs(input) {
  Array.from(input.files).slice(0,5).forEach(f=>{
    const r = new FileReader();
    r.onload = e => {
      afterImgs.push(e.target.result);
      document.getElementById('prevAfter').innerHTML = afterImgs.map((s,i)=>`
        <div class="img-thumb"><img src="${s}" onclick="openLB('${s}')">
        <button class="del-img" onclick="afterImgs.splice(${i},1);handleAfterImgs({files:[]})">‚úï</button></div>`).join('');
    };
    r.readAsDataURL(f);
  });
}

async function saveEdit() {
  const techId  = document.getElementById('newTech').value;
  const status  = document.getElementById('newStatus').value;
  const note    = document.getElementById('newNote').value;
  let ticket    = DB.getById(currentId);

  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°
  if (afterImgs.length) DB.addImages(currentId, 'after', afterImgs);

  // ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏ä‡πà‡∏≤‡∏á
  if (techId && techId !== ticket.technicianId) {
    DB.assign(currentId, techId, note || '', 'admin');
    ticket = DB.getById(currentId);
    const tech = DB.getTechById(techId);
    // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    const cfg = DB.getSettings();
    await NOTIFY.sendAll(ticket, 'assigned', note, tech?.email || cfg.adminEmail);
  }

  // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
  if (status !== ticket.status) {
    DB.updateStatus(currentId, status, note || '', 'admin');
    ticket = DB.getById(currentId);
    await NOTIFY.sendAll(ticket, status, note, ticket.email || DB.getSettings().adminEmail);
  } else if (note && !(techId && techId !== ticket.technicianId)) {
    DB.addHistory(currentId, 'note', note, 'admin');
  }

  closeModal();
  renderAll();
  showToast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!', 'success');
}

function delTicket(id) {
  if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return;
  DB.delete(id); renderAll();
  showToast('üóëÔ∏è ‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß', 'error');
}

function closeModal() { document.getElementById('modalO').classList.remove('open'); }

/* TECHNICIANS */
function renderTechs() {
  const techs = DB.getTechs();
  const el = document.getElementById('techList');
  if (!techs.length) { el.innerHTML='<div style="text-align:center;padding:32px;color:var(--muted)">üë∑ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡πà‡∏≤‡∏á ‡∏Å‡∏î "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà"</div>'; return; }
  el.innerHTML = techs.map(t => {
    const wl = DB.techWorkload(t.id);
    const pct = Math.min(100, wl*20);
    return `<div class="tech-card">
      <div class="tech-avatar">${t.name.charAt(0)}</div>
      <div class="tech-info">
        <div class="tech-name">üë∑ ${t.name} <span class="badge badge-${t.active?'done':'pending'}">${t.active?'‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô':'‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á'}</span></div>
        <div class="tech-meta">üìû ${t.phone}${t.email?` ¬∑ üìß ${t.email}`:''}${t.skill?` ¬∑ üîß ${t.skill}`:''}</div>
        <div style="font-size:.78rem;color:var(--muted);margin-top:3px">‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏°‡∏∑‡∏≠: <strong>${wl}</strong></div>
        <div class="workload-bar"><div class="workload-fill" style="width:${pct}%;background:${pct>60?'#E74C3C':pct>30?'#F4A926':'#27AE60'}"></div></div>
      </div>
      <div style="display:flex;gap:6px">
        <button class="btn btn-warning btn-sm" onclick="editTech('${t.id}')">‚úèÔ∏è</button>
        <button class="btn btn-danger btn-sm" onclick="if(confirm('‡∏•‡∏ö‡∏ä‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ?')){DB.deleteTech('${t.id}');renderTechs()}">üóëÔ∏è</button>
      </div>
    </div>`;
  }).join('');
}

function openAddTech() {
  techEditId = null;
  document.getElementById('techModalTitle').textContent = '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà';
  ['tName','tPhone','tEmail','tSkill','tContact'].forEach(id => document.getElementById(id).value='');
  document.getElementById('techModal').classList.add('open');
}
function editTech(id) {
  techEditId = id;
  const t = DB.getTechById(id);
  document.getElementById('techModalTitle').textContent = '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏≤‡∏á';
  document.getElementById('tName').value    = t.name||'';
  document.getElementById('tPhone').value   = t.phone||'';
  document.getElementById('tEmail').value   = t.email||'';
  document.getElementById('tSkill').value   = t.skill||'';
  document.getElementById('tContact').value = t.contact||'';
  document.getElementById('techModal').classList.add('open');
}
function saveTech() {
  const name = document.getElementById('tName').value.trim();
  if (!name) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≤‡∏á','error'); return; }
  const data = {
    name, phone:document.getElementById('tPhone').value,
    email:document.getElementById('tEmail').value,
    skill:document.getElementById('tSkill').value,
    contact:document.getElementById('tContact').value,
    active:true,
  };
  if (techEditId) DB.updateTech(techEditId, data);
  else DB.addTech(data);
  closeTechModal(); renderTechs();
  showToast(techEditId?'‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß':'‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß','success');
}
function closeTechModal() { document.getElementById('techModal').classList.remove('open'); }

/* SETTINGS */
function loadSettings() {
  const s = DB.getSettings();
  document.getElementById('sOrgName').value   = s.orgName||'';
  document.getElementById('sAdminEmail').value= s.adminEmail||'';
  document.getElementById('sTgToken').value   = s.telegramBotToken||'';
  document.getElementById('sTgChat').value    = s.telegramChatId||'';
  document.getElementById('sWebhook').value   = s.webhookUrl||'';
  document.getElementById('sGasUrl').value    = s.googleScriptUrl||'';
  document.getElementById('sNotifyNew').checked    = s.notifyOnNew!==false;
  document.getElementById('sNotifyAssign').checked = s.notifyOnAssign!==false;
  document.getElementById('sNotifyDone').checked   = s.notifyOnDone!==false;
  document.getElementById('sNotifyRating').checked = s.notifyOnRating!==false;
}
function saveSettings() {
  const s = DB.getSettings();
  DB.saveSettings({
    ...s,
    orgName:         document.getElementById('sOrgName').value,
    adminEmail:      document.getElementById('sAdminEmail').value,
    telegramBotToken:document.getElementById('sTgToken').value,
    telegramChatId:  document.getElementById('sTgChat').value,
    webhookUrl:      document.getElementById('sWebhook').value,
    googleScriptUrl: document.getElementById('sGasUrl').value,
    notifyOnNew:     document.getElementById('sNotifyNew').checked,
    notifyOnAssign:  document.getElementById('sNotifyAssign').checked,
    notifyOnDone:    document.getElementById('sNotifyDone').checked,
    notifyOnRating:  document.getElementById('sNotifyRating').checked,
  });
  showToast('üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß','success');
}

async function testTg() {
  const el = document.getElementById('tgResult');
  const logEl = document.getElementById('tgLog');
  el.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö...';
  // temp save
  DB.saveSettings({...DB.getSettings(), telegramBotToken:document.getElementById('sTgToken').value, telegramChatId:document.getElementById('sTgChat').value});
  const r = await NOTIFY.testTelegram();
  el.textContent = r.ok ? '‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!' : `‚ùå ${r.reason}`;
  logEl.textContent = JSON.stringify(r,null,2);
}
async function testWh() {
  const el = document.getElementById('whResult');
  const logEl = document.getElementById('whLog');
  el.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö...';
  DB.saveSettings({...DB.getSettings(), webhookUrl:document.getElementById('sWebhook').value});
  const r = await NOTIFY.testWebhook();
  el.textContent = r.ok ? `‚úÖ ${r.status}` : `‚ùå ${r.reason||r.status}`;
  logEl.textContent = JSON.stringify(r,null,2);
}

/* EXPORT CSV */
function exportCSV() {
  const tickets = DB.getAll();
  const rows = [['‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç','‡∏ä‡∏∑‡πà‡∏≠','‡πÄ‡∏ö‡∏≠‡∏£‡πå','‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà','‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó','‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô','‡∏ä‡πà‡∏≤‡∏á','‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞','‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô','‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']];
  tickets.forEach(t=>{
    const tech = t.technicianId ? DB.getTechById(t.technicianId)?.name : '';
    rows.push([t.id,t.name,t.phone,t.location,DB.categoryLabel(t.category),DB.priorityLabel(t.priority),tech||'',DB.statusLabel(t.status),t.rating||'',fmtDate(t.createdAt)]);
  });
  const csv = '\uFEFF'+rows.map(r=>r.map(v=>`"${v}"`).join(',')).join('\n');
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
  a.download = `repair_export_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
}

/* UTILS */
function openLB(src){document.getElementById('lbImg').src=src;document.getElementById('lightbox').classList.add('open')}
function showToast(msg,type='success'){const e=document.getElementById('toast');e.textContent=msg;e.className=`toast ${type} show`;setTimeout(()=>e.className='toast',3500)}
function fmtDate(iso){if(!iso)return'-';return new Date(iso).toLocaleString('th-TH',{year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'})}

document.getElementById('lightbox').addEventListener('click',e=>{if(e.target===document.getElementById('lightbox'))document.getElementById('lightbox').classList.remove('open')});
renderAll();
</script>
</body>
</html>
