<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ | ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Kanit:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--p:#0A2342;--p2:#1B4F8A;--acc:#F4A926;--ok:#27AE60;--err:#E74C3C;--bg:#EEF2F7;--card:#fff;--text:#1A2B3C;--muted:#7A8DA0;--border:#D1DCE8;--sh:0 4px 24px rgba(10,35,66,.10)}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Sarabun',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
header{background:var(--p);color:#fff;padding:0 36px;display:flex;align-items:center;justify-content:space-between;height:68px;box-shadow:0 2px 16px rgba(10,35,66,.18);position:sticky;top:0;z-index:100}
.logo{font-family:'Kanit',sans-serif;font-size:1.35rem;font-weight:700;display:flex;align-items:center;gap:10px}
.logo-icon{width:36px;height:36px;background:var(--acc);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:1.1rem}
.nav a{color:rgba(255,255,255,.75);text-decoration:none;margin-left:22px;font-size:.9rem;transition:color .2s}
.nav a:hover,.nav a.active{color:var(--acc)}
.hero{background:linear-gradient(135deg,var(--p) 0%,var(--p2) 100%);color:#fff;padding:52px 36px;text-align:center}
.hero h1{font-family:'Kanit',sans-serif;font-size:2.1rem;font-weight:700;margin-bottom:10px}
.hero p{opacity:.8}
.container{max-width:760px;margin:0 auto;padding:36px 16px}
.card{background:var(--card);border-radius:16px;box-shadow:var(--sh);padding:28px;margin-bottom:20px}
.card-title{font-family:'Kanit',sans-serif;font-size:1.05rem;font-weight:700;color:var(--p);margin-bottom:18px;display:flex;align-items:center;gap:8px}
.search-bar{display:flex;gap:10px;margin-bottom:8px}
input{flex:1;padding:11px 14px;border:1.5px solid var(--border);border-radius:9px;font-family:'Sarabun',sans-serif;font-size:.95rem;color:var(--text);background:#fafbfd;outline:none;transition:border-color .2s}
input:focus{border-color:var(--p)}
.btn{display:inline-flex;align-items:center;gap:6px;padding:11px 20px;border:none;border-radius:9px;font-family:'Sarabun',sans-serif;font-size:.92rem;font-weight:700;cursor:pointer;transition:all .2s}
.btn-primary{background:var(--p);color:#fff}.btn-primary:hover{background:var(--p2)}
.badge{display:inline-block;padding:3px 10px;border-radius:18px;font-size:.73rem;font-weight:700;white-space:nowrap}
.badge-pending{background:#FFF3CD;color:#856404}.badge-assigned{background:#E8D5FF;color:#6B21A8}.badge-inprogress{background:#CCE5FF;color:#0056B3}.badge-done{background:#D4EDDA;color:#155724}
.badge-low{background:#EDFBF4;color:#27AE60}.badge-medium{background:#FFF8EC;color:#D68910}.badge-high{background:#FEECEB;color:#E74C3C}
/* STEPPER */
.stepper{display:flex;align-items:center;margin:20px 0}
.step{flex:1;text-align:center;position:relative}
.step::before{content:'';position:absolute;top:16px;left:50%;right:-50%;height:3px;background:var(--border);z-index:0}
.step:last-child::before{display:none}
.step-circle{width:32px;height:32px;border-radius:50%;background:var(--border);display:flex;align-items:center;justify-content:center;margin:0 auto 8px;font-size:.9rem;position:relative;z-index:1;transition:all .3s}
.step.done .step-circle{background:var(--p);color:#fff}
.step.current .step-circle{background:var(--acc);color:var(--p);transform:scale(1.15);box-shadow:0 0 0 4px rgba(244,169,38,.22)}
.step-label{font-size:.72rem;color:var(--muted);font-weight:500}
.step.done .step-label,.step.current .step-label{color:var(--p);font-weight:700}
.det-row{display:flex;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--border);font-size:.88rem}
.det-row:last-child{border-bottom:none}.det-lbl{color:var(--muted)}.det-val{font-weight:700;text-align:right;max-width:58%}
.gallery-grid{display:flex;flex-wrap:wrap;gap:7px;margin-top:8px}
.gallery-grid img{width:72px;height:72px;object-fit:cover;border-radius:7px;border:2px solid var(--border);cursor:pointer}
.timeline{padding:14px;background:var(--bg);border-radius:10px;margin-top:12px}
.t-item{display:flex;gap:9px;margin-bottom:8px;font-size:.82rem}
.t-dot{width:7px;height:7px;background:var(--p);border-radius:50%;margin-top:4px;flex-shrink:0}
/* RATING */
.stars{display:flex;gap:8px;font-size:2rem;cursor:pointer;margin-top:10px}
.stars span{opacity:.28;transition:opacity .2s;user-select:none}
.stars span.active,.stars span:hover~span{opacity:1}
.stars:hover span{opacity:1}
textarea{width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:9px;font-family:'Sarabun',sans-serif;font-size:.9rem;resize:vertical;outline:none;min-height:70px}
textarea:focus{border-color:var(--p)}
.toast{position:fixed;top:80px;right:18px;padding:13px 20px;border-radius:11px;font-weight:700;transform:translateX(200%);transition:transform .4s cubic-bezier(.34,1.56,.64,1);z-index:999;font-size:.9rem}
.toast.success{background:var(--ok);color:#fff}.toast.show{transform:translateX(0)}
#lightbox{position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:500;display:none;align-items:center;justify-content:center}
#lightbox.open{display:flex}
#lightbox img{max-width:92vw;max-height:92vh;border-radius:10px}
#lightbox .lb-close{position:absolute;top:20px;right:24px;color:#fff;font-size:2rem;cursor:pointer;background:none;border:none}
footer{background:var(--p);color:rgba(255,255,255,.5);text-align:center;padding:20px;font-size:.8rem;margin-top:32px}
</style>
</head>
<body>
<header>
  <div class="logo"><div class="logo-icon">üîß</div>RepairSys</div>
  <nav class="nav">
    <a href="index.html">‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</a>
    <a href="status.html" class="active">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</a>
    <a href="admin/index.html">Admin</a>
    <a href="technician/index.html">‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡πà‡∏≤‡∏á</a>
  </nav>
</header>
<div class="hero">
  <h1>üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°</h1>
  <p>‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</p>
</div>
<div class="container">
  <div class="card">
    <div class="card-title"><span>üîé</span> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ã‡πà‡∏≠‡∏°</div>
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="‡∏Å‡∏£‡∏≠‡∏Å REP-XXXXXX ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠">
      <button class="btn btn-primary" onclick="doSearch()">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
    </div>
    <div id="result"></div>
  </div>
</div>

<div id="lightbox"><button class="lb-close" onclick="document.getElementById('lightbox').classList.remove('open')">‚úï</button><img id="lbImg"></div>
<div class="toast success" id="toast"></div>
<footer>¬© 2025 ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</footer>

<script src="js/db.js"></script>
<script src="js/notify.js"></script>
<script>
document.getElementById('searchInput').addEventListener('keydown',e=>{if(e.key==='Enter')doSearch()});
let starVal=0; let searchResultId=null;

function doSearch() {
  const q = document.getElementById('searchInput').value.trim();
  if(!q) return;
  const results = DB.search(q);
  const el = document.getElementById('result');
  if(!results.length){el.innerHTML=`<div style="text-align:center;padding:32px;color:var(--muted)">üîç ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ "${q}"</div>`;return;}
  el.innerHTML = results.map(t=>renderResult(t)).join('<div style="height:16px"></div>');
}

function renderResult(t) {
  const tech=t.technicianId?DB.getTechById(t.technicianId):null;
  const steps=['pending','assigned','inprogress','done'];
  const labels=['‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£','‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢','‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°','‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß'];
  const icons=['‚è≥','üë∑','üîß','‚úÖ'];
  const curr=steps.indexOf(t.status);

  let html=`<div style="border:2px solid var(--border);border-radius:14px;padding:20px;margin-top:10px">
    <div style="font-size:.75rem;color:var(--muted)">${t.id}</div>
    <div style="font-weight:700;font-size:1.05rem;margin:4px 0">üìç ${t.location} ‚Äî ${DB.categoryLabel(t.category)}</div>
    <div class="stepper">${steps.map((s,i)=>`
      <div class="step ${i<curr?'done':''} ${i===curr?'current':''}">
        <div class="step-circle">${i<curr?'‚úì':icons[i]}</div>
        <div class="step-label">${labels[i]}</div>
      </div>`).join('')}</div>

    <div class="det-row"><span class="det-lbl">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</span><span class="det-val">${t.name} ¬∑ ${t.phone}</span></div>
    ${tech?`<div class="det-row"><span class="det-lbl">üë∑ ‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</span><span class="det-val">${tech.name} (${tech.phone})</span></div>`:''}
    <div class="det-row"><span class="det-lbl">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô</span><span class="det-val"><span class="badge badge-${t.priority}">${DB.priorityLabel(t.priority)}</span></span></div>
    <div class="det-row"><span class="det-lbl">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á</span><span class="det-val">${fmtDate(t.createdAt)}</span></div>
    <div class="det-row" style="flex-direction:column;gap:4px"><span class="det-lbl">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span><span>${t.description}</span></div>`;

  if(t.imagesBefore?.length){html+=`<div style="margin-top:10px"><strong style="font-size:.84rem">üì∑ ‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏ã‡πà‡∏≠‡∏°</strong><div class="gallery-grid">${t.imagesBefore.map(s=>`<img src="${s}" onclick="openLB('${s}')">`).join('')}</div></div>`;}
  if(t.imagesAfter?.length){html+=`<div style="margin-top:10px"><strong style="font-size:.84rem">‚úÖ ‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°</strong><div class="gallery-grid">${t.imagesAfter.map(s=>`<img src="${s}" onclick="openLB('${s}')">`).join('')}</div></div>`;}

  // RATING
  if(t.status==='done' && !t.rating){
    html+=`<div style="margin-top:16px;padding:16px;background:#FFFBF0;border-radius:12px;border:1.5px solid #F4A926">
      <strong>‚≠ê ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°</strong>
      <div class="stars" id="stars_${t.id}">${[1,2,3,4,5].map(n=>`<span data-v="${n}" data-id="${t.id}" onclick="setStar(${n},'${t.id}')">‚òÖ</span>`).join('')}</div>
      <textarea id="rc_${t.id}" placeholder="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô..." style="margin-top:8px"></textarea>
      <button class="btn btn-primary" style="margin-top:8px" onclick="submitRating('${t.id}')">‚≠ê ‡∏™‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
    </div>`;
  } else if(t.rating){
    html+=`<div style="margin-top:10px;padding:12px;background:#FFFBF0;border-radius:10px"><strong>‚≠ê ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö: ${t.rating}/5</strong>${t.ratingComment?`<p style="margin-top:5px;color:var(--muted);font-size:.86rem">"${t.ratingComment}"</p>`:''}</div>`;
  }

  // Timeline
  html+=`<div class="timeline"><div style="font-weight:700;font-size:.84rem;margin-bottom:8px;color:var(--p)">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>
    ${t.history.slice().reverse().map(h=>`<div class="t-item"><div class="t-dot"></div><div><strong>${h.note}</strong><br><span style="color:var(--muted)">${fmtDate(h.date)}</span></div></div>`).join('')}
  </div></div>`;

  return html;
}

function setStar(v,id){
  starVal=v;
  document.getElementById('stars_'+id)?.querySelectorAll('span').forEach(s=>s.classList.toggle('active',+s.dataset.v<=v));
}

async function submitRating(id){
  if(!starVal){showToast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô');return;}
  const comment=document.getElementById('rc_'+id)?.value||'';
  const t=DB.setRating(id,starVal,comment);
  await NOTIFY.sendAll(t,'rated',`‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ${starVal}/5`,'');
  showToast('‚≠ê ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô!');
  doSearch();
}

function openLB(src){document.getElementById('lbImg').src=src;document.getElementById('lightbox').classList.add('open')}
function showToast(msg){const e=document.getElementById('toast');e.textContent=msg;e.classList.add('show');setTimeout(()=>e.classList.remove('show'),3500)}
function fmtDate(iso){if(!iso)return'-';return new Date(iso).toLocaleString('th-TH',{year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'})}

document.getElementById('lightbox').addEventListener('click',e=>{if(e.target===document.getElementById('lightbox'))document.getElementById('lightbox').classList.remove('open')});

const p=new URLSearchParams(location.search);
if(p.get('id')){document.getElementById('searchInput').value=p.get('id');doSearch();}
</script>
</body>
</html>
