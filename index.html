<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Kanit:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --p:#0A2342;--p2:#1B4F8A;--acc:#F4A926;--ok:#27AE60;--err:#E74C3C;
  --bg:#EEF2F7;--card:#fff;--text:#1A2B3C;--muted:#7A8DA0;--border:#D1DCE8;
  --sh:0 4px 24px rgba(10,35,66,.10);
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Sarabun',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
/* NAV */
header{background:var(--p);color:#fff;padding:0 40px;display:flex;align-items:center;justify-content:space-between;height:70px;box-shadow:0 2px 16px rgba(10,35,66,.18);position:sticky;top:0;z-index:100}
.logo{font-family:'Kanit',sans-serif;font-size:1.4rem;font-weight:700;display:flex;align-items:center;gap:12px}
.logo-icon{width:38px;height:38px;background:var(--acc);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.2rem}
.nav a{color:rgba(255,255,255,.8);text-decoration:none;margin-left:24px;font-size:.92rem;transition:color .2s}
.nav a:hover,.nav a.active{color:var(--acc)}
/* HERO */
.hero{background:linear-gradient(135deg,var(--p) 0%,var(--p2) 100%);color:#fff;padding:52px 40px;text-align:center}
.hero h1{font-family:'Kanit',sans-serif;font-size:2.3rem;font-weight:700;margin-bottom:10px}
.hero p{font-size:1.05rem;opacity:.8}
/* STATS */
.stats-bar{display:grid;grid-template-columns:repeat(4,1fr);background:var(--acc);padding:18px 40px;gap:12px}
.stat-item{text-align:center;color:var(--p)}
.stat-num{font-family:'Kanit',sans-serif;font-size:1.8rem;font-weight:700;display:block}
.stat-label{font-size:.8rem;font-weight:600;opacity:.72}
/* LAYOUT */
.container{max-width:1100px;margin:0 auto;padding:36px 20px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:28px}
/* CARD */
.card{background:var(--card);border-radius:16px;box-shadow:var(--sh);padding:28px}
.card-title{font-family:'Kanit',sans-serif;font-size:1.1rem;font-weight:700;color:var(--p);margin-bottom:20px;padding-bottom:14px;border-bottom:2px solid var(--border);display:flex;align-items:center;gap:8px}
/* FORM */
.fg{margin-bottom:16px}
label{display:block;font-size:.88rem;font-weight:600;color:var(--text);margin-bottom:6px}
label .req{color:var(--err)}
input,select,textarea{width:100%;padding:10px 14px;border:1.5px solid var(--border);border-radius:10px;font-family:'Sarabun',sans-serif;font-size:.93rem;color:var(--text);background:#FAFBFD;outline:none;transition:border-color .2s,box-shadow .2s}
input:focus,select:focus,textarea:focus{border-color:var(--p);box-shadow:0 0 0 3px rgba(10,35,66,.07);background:#fff}
textarea{resize:vertical;min-height:90px}
/* PRIORITY */
.pgrp{display:flex;gap:8px}
.pbtn{flex:1;padding:9px 6px;border:2px solid var(--border);border-radius:10px;background:#fff;cursor:pointer;text-align:center;font-family:'Sarabun',sans-serif;font-size:.83rem;font-weight:700;transition:all .2s;color:var(--muted)}
.pbtn.low.sel{border-color:#27AE60;background:#EDFBF4;color:#27AE60}
.pbtn.medium.sel{border-color:var(--acc);background:#FFF8EC;color:#D68910}
.pbtn.high.sel{border-color:var(--err);background:#FEECEB;color:var(--err)}
/* IMAGE UPLOAD */
.img-upload-zone{border:2px dashed var(--border);border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:all .2s;position:relative}
.img-upload-zone:hover{border-color:var(--p);background:rgba(10,35,66,.03)}
.img-upload-zone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.img-preview-grid{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
.img-thumb{position:relative;width:72px;height:72px;border-radius:8px;overflow:hidden;border:2px solid var(--border)}
.img-thumb img{width:100%;height:100%;object-fit:cover}
.img-thumb .del-img{position:absolute;top:2px;right:2px;background:rgba(0,0,0,.6);color:#fff;border:none;border-radius:50%;width:18px;height:18px;font-size:.7rem;cursor:pointer;display:flex;align-items:center;justify-content:center}
/* BTN */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:11px 22px;border:none;border-radius:10px;font-family:'Sarabun',sans-serif;font-size:.93rem;font-weight:700;cursor:pointer;transition:all .2s}
.btn-primary{background:var(--p);color:#fff;width:100%;margin-top:6px}
.btn-primary:hover{background:var(--p2);transform:translateY(-1px);box-shadow:0 6px 20px rgba(10,35,66,.22)}
/* TICKET ITEM */
.ticket-item{border:1.5px solid var(--border);border-radius:12px;padding:14px 16px;margin-bottom:12px;cursor:pointer;transition:all .2s;display:grid;grid-template-columns:1fr auto;align-items:start;gap:8px}
.ticket-item:hover{border-color:var(--p);box-shadow:0 2px 12px rgba(10,35,66,.09)}
.tick-id{font-size:.75rem;color:var(--muted);margin-bottom:3px}
.tick-title{font-weight:700;font-size:.92rem;margin-bottom:3px}
.tick-meta{font-size:.8rem;color:var(--muted)}
/* BADGE */
.badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:.73rem;font-weight:700;white-space:nowrap}
.badge-pending{background:#FFF3CD;color:#856404}.badge-assigned{background:#E8D5FF;color:#6B21A8}.badge-inprogress{background:#CCE5FF;color:#0056B3}.badge-done{background:#D4EDDA;color:#155724}
.badge-low{background:#EDFBF4;color:#27AE60}.badge-medium{background:#FFF8EC;color:#D68910}.badge-high{background:#FEECEB;color:var(--err)}
/* TOAST */
.toast{position:fixed;top:84px;right:20px;padding:14px 22px;border-radius:12px;font-weight:700;transform:translateX(200%);transition:transform .4s cubic-bezier(.34,1.56,.64,1);z-index:999;max-width:320px;font-size:.92rem}
.toast.success{background:var(--ok);color:#fff}.toast.error{background:var(--err);color:#fff}
.toast.show{transform:translateX(0)}
/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;display:flex;align-items:center;justify-content:center;padding:16px;opacity:0;pointer-events:none;transition:opacity .3s}
.modal-overlay.open{opacity:1;pointer-events:all}
.modal{background:#fff;border-radius:18px;padding:28px;max-width:560px;width:100%;max-height:92vh;overflow-y:auto;transform:scale(.92);transition:transform .3s}
.modal-overlay.open .modal{transform:scale(1)}
.modal-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
.modal-close{width:32px;height:32px;border:none;background:var(--bg);border-radius:8px;cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;color:var(--muted)}
.modal-close:hover{background:var(--border);color:var(--text)}
.det-row{display:flex;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--border);font-size:.88rem}
.det-row:last-child{border-bottom:none}
.det-lbl{color:var(--muted);font-weight:500}.det-val{font-weight:700;text-align:right;max-width:58%}
/* RATING */
.stars{display:flex;gap:6px;font-size:1.6rem;cursor:pointer}
.stars span{opacity:.35;transition:opacity .2s;user-select:none}
.stars span.active,.stars span:hover{opacity:1}
.timeline{margin-top:14px;padding:14px;background:var(--bg);border-radius:10px}
.t-item{display:flex;gap:10px;margin-bottom:10px;font-size:.82rem}
.t-dot{width:8px;height:8px;background:var(--p);border-radius:50%;margin-top:4px;flex-shrink:0}
.gallery-grid{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.gallery-grid img{width:80px;height:80px;object-fit:cover;border-radius:8px;border:2px solid var(--border);cursor:pointer}
/* LIGHTBOX */
#lightbox{position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:500;display:none;align-items:center;justify-content:center}
#lightbox.open{display:flex}
#lightbox img{max-width:92vw;max-height:92vh;border-radius:10px}
#lightbox .lb-close{position:absolute;top:20px;right:24px;color:#fff;font-size:2rem;cursor:pointer;background:none;border:none}
footer{background:var(--p);color:rgba(255,255,255,.5);text-align:center;padding:22px;font-size:.82rem;margin-top:36px}
@media(max-width:768px){.grid-2{grid-template-columns:1fr}.stats-bar{grid-template-columns:repeat(2,1fr)}.hero{padding:36px 16px}.hero h1{font-size:1.65rem}header{padding:0 16px}}
</style>
</head>
<body>

<header>
  <div class="logo"><div class="logo-icon">üîß</div>RepairSys</div>
  <nav class="nav">
    <a href="index.html" class="active">‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</a>
    <a href="status.html">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</a>
    <a href="admin/index.html">‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°</a>
    <a href="technician/index.html">‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡πà‡∏≤‡∏á</a>
  </nav>
</header>

<div class="hero">
  <h1>üîß ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h1>
  <p>‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‚Äî ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏ä‡πà‡∏≤‡∏á ‚Äî ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô ‚Äî ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•</p>
</div>

<div class="stats-bar">
  <div class="stat-item"><span class="stat-num" id="sTotal">0</span><div class="stat-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div>
  <div class="stat-item"><span class="stat-num" id="sPending">0</span><div class="stat-label">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div></div>
  <div class="stat-item"><span class="stat-num" id="sProgress">0</span><div class="stat-label">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°</div></div>
  <div class="stat-item"><span class="stat-num" id="sDone">0</span><div class="stat-label">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</div></div>
</div>

<div class="container">
  <div class="grid-2">
    <!-- FORM -->
    <div class="card">
      <div class="card-title"><span>üìã</span> ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</div>
      <form id="repairForm">
        <div class="fg"><label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span class="req">*</span></label><input id="fName" required placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì"></div>
        <div class="fg"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå <span class="req">*</span></label><input id="fPhone" required placeholder="0xx-xxx-xxxx"></div>
        <div class="fg"><label>‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô)</label><input id="fEmail" type="email" placeholder="example@email.com"></div>
        <div class="fg"><label>‡∏´‡πâ‡∏≠‡∏á / ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà <span class="req">*</span></label><input id="fLocation" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡πâ‡∏≠‡∏á 301 ‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ A"></div>
        <div class="fg">
          <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏° <span class="req">*</span></label>
          <select id="fCategory" required>
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó --</option>
            <option value="electrical">‚ö° ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ / ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ü</option>
            <option value="plumbing">üíß ‡∏õ‡∏£‡∏∞‡∏õ‡∏≤ / ‡∏ô‡πâ‡∏≥</option>
            <option value="ac">‚ùÑÔ∏è ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</option>
            <option value="furniture">ü™ë ‡πÄ‡∏ü‡∏≠‡∏£‡πå‡∏ô‡∏¥‡πÄ‡∏à‡∏≠‡∏£‡πå / ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</option>
            <option value="network">üíª ‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå / ‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢</option>
            <option value="other">üì¶ ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
          </select>
        </div>
        <div class="fg">
          <label>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô</label>
          <div class="pgrp">
            <button type="button" class="pbtn low sel" data-p="low">üü¢ ‡∏õ‡∏Å‡∏ï‡∏¥</button>
            <button type="button" class="pbtn medium" data-p="medium">üü° ‡∏î‡πà‡∏ß‡∏ô</button>
            <button type="button" class="pbtn high" data-p="high">üî¥ ‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å</button>
          </div>
        </div>
        <div class="fg"><label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤ <span class="req">*</span></label><textarea id="fDesc" required placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö..."></textarea></div>

        <!-- IMAGE UPLOAD BEFORE -->
        <div class="fg">
          <label>üì∑ ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏Å‡πà‡∏≠‡∏ô‡∏ã‡πà‡∏≠‡∏°)</label>
          <div class="img-upload-zone" id="dropBefore">
            <input type="file" id="fileBefore" accept="image/*" multiple onchange="handleFiles('before',this)">
            <div>üìÅ ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</div>
            <small style="color:var(--muted)">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö JPG, PNG, GIF ‚Äî ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5 ‡∏£‡∏π‡∏õ</small>
          </div>
          <div class="img-preview-grid" id="previewBefore"></div>
        </div>

        <button type="submit" class="btn btn-primary">üì® ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</button>
      </form>
    </div>

    <!-- TICKET LIST -->
    <div class="card">
      <div class="card-title"><span>üóÇÔ∏è</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
      <div id="ticketList"></div>
    </div>
  </div>
</div>

<!-- MODAL: TICKET DETAIL + RATING -->
<div class="modal-overlay" id="modalO" onclick="if(event.target===this)closeModal()">
  <div class="modal" id="modal">
    <div class="modal-hd">
      <div class="card-title" style="margin:0;padding:0;border:none;font-size:1rem">üîç ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ã‡πà‡∏≠‡∏°</div>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<!-- LIGHTBOX -->
<div id="lightbox"><button class="lb-close" onclick="closeLB()">‚úï</button><img id="lbImg" src=""></div>

<div class="toast" id="toast"></div>
<footer>¬© 2025 ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå v2 | ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡πÇ‡∏™‡∏ï‡∏ó‡∏±‡∏®‡∏ô‡∏π‡∏õ‡∏Å‡∏£‡∏ì‡πå ‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏à‡∏¥‡∏ï‡∏£‡∏•‡∏î‡∏≤ </footer>

<script src="js/db.js"></script>
<script src="js/notify.js"></script>
<script>
let selPriority = 'low';
let imgsBefore = [];
let currentTicketId = null;
let starVal = 0;

/* PRIORITY BTN */
document.querySelectorAll('.pbtn').forEach(b => {
  b.addEventListener('click', () => {
    document.querySelectorAll('.pbtn').forEach(x => x.classList.remove('sel'));
    b.classList.add('sel');
    selPriority = b.dataset.p;
  });
});

/* IMAGE HANDLING */
function handleFiles(type, input) {
  const files = Array.from(input.files);
  files.slice(0, 5).forEach(f => {
    const reader = new FileReader();
    reader.onload = e => {
      if (type === 'before') {
        imgsBefore.push(e.target.result);
        renderPreviews('before', imgsBefore, 'previewBefore');
      }
    };
    reader.readAsDataURL(f);
  });
}
function renderPreviews(type, arr, gridId) {
  const g = document.getElementById(gridId);
  g.innerHTML = arr.map((src, i) => `
    <div class="img-thumb">
      <img src="${src}" onclick="openLB('${src}')">
      <button class="del-img" onclick="removeImg('${type}',${i})">‚úï</button>
    </div>
  `).join('');
}
function removeImg(type, idx) {
  if (type === 'before') { imgsBefore.splice(idx,1); renderPreviews('before', imgsBefore, 'previewBefore'); }
}
function openLB(src) {
  document.getElementById('lbImg').src = src;
  document.getElementById('lightbox').classList.add('open');
}
function closeLB() { document.getElementById('lightbox').classList.remove('open'); }
document.getElementById('lightbox').addEventListener('click', e => { if(e.target===document.getElementById('lightbox')) closeLB(); });

/* SUBMIT */
document.getElementById('repairForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const btn = this.querySelector('.btn-primary');
  btn.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...'; btn.disabled = true;

  const ticket = DB.add({
    name: document.getElementById('fName').value,
    phone: document.getElementById('fPhone').value,
    email: document.getElementById('fEmail').value,
    location: document.getElementById('fLocation').value,
    category: document.getElementById('fCategory').value,
    priority: selPriority,
    description: document.getElementById('fDesc').value,
    imagesBefore: [...imgsBefore],
  });

  // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (fire and forget)
  NOTIFY.sendAll(ticket, 'pending', '', ticket.email).catch(console.error);

  showToast(`‚úÖ ‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç: ${ticket.id}`, 'success');
  this.reset();
  imgsBefore = [];
  document.getElementById('previewBefore').innerHTML = '';
  document.querySelectorAll('.pbtn').forEach(x => x.classList.remove('sel'));
  document.querySelector('.pbtn.low').classList.add('sel');
  selPriority = 'low';
  btn.textContent = 'üì® ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°'; btn.disabled = false;
  renderAll();
});

/* RENDER TICKETS */
function renderAll() {
  const s = DB.stats();
  document.getElementById('sTotal').textContent   = s.total;
  document.getElementById('sPending').textContent  = s.pending;
  document.getElementById('sProgress').textContent = s.inprogress;
  document.getElementById('sDone').textContent     = s.done;

  const el = document.getElementById('ticketList');
  const tickets = DB.getAll().slice(0,12);
  if (!tickets.length) { el.innerHTML = '<div style="text-align:center;padding:40px;color:var(--muted)">üì≠ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>'; return; }
  el.innerHTML = tickets.map(t => {
    const tech = t.technicianId ? DB.getTechById(t.technicianId) : null;
    return `<div class="ticket-item" onclick="openModal('${t.id}')">
      <div>
        <div class="tick-id">${t.id} ‚Äî ${fmtDate(t.createdAt)}</div>
        <div class="tick-title">üìç ${t.location} ‚Äî ${DB.categoryLabel(t.category)}</div>
        <div class="tick-meta">üë§ ${t.name} ¬∑ üìû ${t.phone}${tech ? ` ¬∑ üë∑ ${tech.name}` : ''}</div>
        <div style="margin-top:5px;display:flex;gap:5px;flex-wrap:wrap">
          <span class="badge badge-${t.priority}">${DB.priorityLabel(t.priority)}</span>
          ${t.rating ? `<span class="badge" style="background:#FFF8DC;color:#8B6914">‚≠ê${t.rating}/5</span>` : ''}
          ${t.imagesBefore?.length ? `<span class="badge" style="background:#E8F4F8;color:#0F6E99">üì∑${t.imagesBefore.length}‡∏£‡∏π‡∏õ</span>` : ''}
        </div>
      </div>
      <span class="badge badge-${t.status}">${DB.statusLabel(t.status)}</span>
    </div>`;
  }).join('');
}

/* MODAL */
function openModal(id) {
  currentTicketId = id;
  const t = DB.getById(id);
  if (!t) return;
  const tech = t.technicianId ? DB.getTechById(t.technicianId) : null;
  starVal = t.rating || 0;

  let body = `
    <div class="det-row"><span class="det-lbl">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç</span><span class="det-val">${t.id}</span></div>
    <div class="det-row"><span class="det-lbl">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span><span class="det-val"><span class="badge badge-${t.status}">${DB.statusLabel(t.status)}</span></span></div>
    <div class="det-row"><span class="det-lbl">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</span><span class="det-val">${t.name}</span></div>
    <div class="det-row"><span class="det-lbl">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</span><span class="det-val">${t.phone}</span></div>
    <div class="det-row"><span class="det-lbl">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</span><span class="det-val">${t.location}</span></div>
    <div class="det-row"><span class="det-lbl">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</span><span class="det-val">${DB.categoryLabel(t.category)}</span></div>
    <div class="det-row"><span class="det-lbl">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô</span><span class="det-val"><span class="badge badge-${t.priority}">${DB.priorityLabel(t.priority)}</span></span></div>
    ${tech ? `<div class="det-row"><span class="det-lbl">üë∑ ‡∏ä‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</span><span class="det-val">${tech.name} (${tech.phone})</span></div>` : ''}
    <div class="det-row" style="flex-direction:column;gap:5px"><span class="det-lbl">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span><span>${t.description}</span></div>
  `;

  // ‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏ã‡πà‡∏≠‡∏°
  if (t.imagesBefore?.length) {
    body += `<div style="margin-top:12px"><strong style="font-size:.88rem">üì∑ ‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏ã‡πà‡∏≠‡∏° (${t.imagesBefore.length} ‡∏£‡∏π‡∏õ)</strong>
    <div class="gallery-grid">${t.imagesBefore.map(s=>`<img src="${s}" onclick="openLB('${s}')">`).join('')}</div></div>`;
  }
  // ‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°
  if (t.imagesAfter?.length) {
    body += `<div style="margin-top:12px"><strong style="font-size:.88rem">‚úÖ ‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏° (${t.imagesAfter.length} ‡∏£‡∏π‡∏õ)</strong>
    <div class="gallery-grid">${t.imagesAfter.map(s=>`<img src="${s}" onclick="openLB('${s}')">`).join('')}</div></div>`;
  }

  // Rating (‡∏ñ‡πâ‡∏≤ done ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)
  if (t.status === 'done' && !t.rating) {
    body += `
    <div style="margin-top:16px;padding:16px;background:#FFFBF0;border-radius:12px;border:1.5px solid #F4A926">
      <strong>‚≠ê ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°</strong>
      <div class="stars" id="stars" style="margin-top:10px">
        ${[1,2,3,4,5].map(n=>`<span data-v="${n}" onclick="setStar(${n})">‚òÖ</span>`).join('')}
      </div>
      <textarea id="ratingComment" placeholder="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..." style="margin-top:8px;width:100%;padding:8px;border:1.5px solid var(--border);border-radius:8px;font-family:Sarabun,sans-serif;resize:vertical;min-height:60px;outline:none"></textarea>
      <button class="btn" style="background:var(--acc);color:var(--p);width:100%;margin-top:8px;font-weight:700" onclick="submitRating()">‚≠ê ‡∏™‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
    </div>`;
  } else if (t.rating) {
    body += `<div style="margin-top:12px;padding:12px;background:#FFFBF0;border-radius:10px">
      <strong>‚≠ê ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö: ${t.rating}/5</strong>
      ${t.ratingComment ? `<p style="margin-top:6px;font-size:.88rem;color:var(--muted)">"${t.ratingComment}"</p>` : ''}
    </div>`;
  }

  // Timeline
  body += `<div class="timeline" style="margin-top:14px">
    <div style="font-weight:700;font-size:.88rem;margin-bottom:10px;color:var(--p)">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>
    ${t.history.slice().reverse().map(h=>`
      <div class="t-item">
        <div class="t-dot"></div>
        <div><strong>${h.note}</strong><br><span style="color:var(--muted)">${fmtDate(h.date)}</span></div>
      </div>`).join('')}
  </div>`;

  document.getElementById('modalBody').innerHTML = body;
  document.getElementById('modalO').classList.add('open');
  renderStars(starVal);
}

function setStar(v) { starVal = v; renderStars(v); }
function renderStars(v) {
  const el = document.getElementById('stars');
  if (!el) return;
  el.querySelectorAll('span').forEach(s => s.classList.toggle('active', +s.dataset.v <= v));
}
function submitRating() {
  if (!starVal) { showToast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡πà‡∏≠‡∏ô','error'); return; }
  const comment = document.getElementById('ratingComment')?.value || '';
  const t = DB.setRating(currentTicketId, starVal, comment);
  NOTIFY.sendAll(t, 'rated', `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ${starVal}/5`, '').catch(console.error);
  closeModal();
  showToast('‚≠ê ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô!','success');
  renderAll();
}

function closeModal() { document.getElementById('modalO').classList.remove('open'); }

/* TOAST */
function showToast(msg, type='success') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = `toast ${type} show`;
  setTimeout(() => el.className = 'toast', 3800);
}
function fmtDate(iso) {
  if (!iso) return '-';
  return new Date(iso).toLocaleString('th-TH',{year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
}

renderAll();
</script>
</body>
</html>
